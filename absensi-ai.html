<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi e-KTP (Gemini AI)</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat ikon (Heroicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <!-- Tesseract.js SUDAH DIHAPUS -->
    
    <style>
        /* ... (CSS yang ada tetap sama) ... */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* dark:gray-700 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #2d3748; /* dark:gray-800 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div class="container mx-auto max-w-lg p-4 min-h-screen">
        
        <!-- Judul Aplikasi & Tombol Pengaturan -->
        <header class="text-center my-6 relative">
            <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">Absensi e-KTP AI</h1>
            <p class="text-md text-gray-600 dark:text-gray-400 mt-1">Scan KTP untuk mencatat kehadiran.</p>
            
            <!-- Tombol Pengaturan API Key -->
            <button id="settings-btn" class="absolute top-0 right-0 p-2 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                <ion-icon name="settings-outline" class="text-3xl"></ion-icon>
            </button>
        </header>

        <!-- Area Kamera -->
        <main>
            <div id="camera-container" class="bg-gray-800 rounded-lg shadow-xl overflow-hidden aspect-video relative flex items-center justify-center">
                <!-- Video stream akan muncul di sini -->
                <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                
                <!-- Tombol untuk memulai kamera -->
                <button id="start-camera-btn" class="absolute z-10 bg-white/20 backdrop-blur-sm text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-white/30 transition-all flex items-center gap-2">
                    <ion-icon name="camera-outline" class="text-2xl"></ion-icon>
                    Mulai Kamera
                </button>

                <!-- Overlay saat memindai -->
                <div id="scan-overlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm flex-col items-center justify-center text-white text-lg font-semibold hidden">
                    <div class="w-16 h-16 border-4 border-t-transparent border-white rounded-full animate-spin"></div>
                    <p id="scan-status" class="mt-4">Memproses Data...</p>
                </div>
            </div>

            <!-- Tombol Aksi Utama -->
            <div class="mt-6">
                <button id="scan-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition-all duration-300 flex items-center justify-center gap-3 text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    <!-- Teks akan diubah oleh JS -->
                    <span>Masukkan API Key di Pengaturan</span>
                </button>
            </div>

            <!-- ... (Sisa HTML tetap sama: Area Daftar Hadir, Modal Konfirmasi, Toast) ... -->
            <!-- Area Daftar Hadir -->
            <section class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Daftar Hadir</h2>
                    <button id="export-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2 text-sm disabled:bg-gray-400">
                        <ion-icon name="download-outline"></ion-icon>
                        Unduh (.csv)
                    </button>
                </div>

                <!-- Kontainer list -->
                <div id="attendance-list" class="bg-white dark:bg-gray-800 rounded-lg shadow-md max-h-64 overflow-y-auto">
                    <p id="empty-state" class="text-center text-gray-500 dark:text-gray-400 p-8">
                        Belum ada data kehadiran.
                    </p>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Konfirmasi Data -->
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm transition-all transform scale-95 opacity-0">
            <h3 class="text-xl font-semibold mb-4">Konfirmasi Data</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Periksa hasil scan AI. Mohon perbaiki jika ada kesalahan.</p>
            <form id="attendance-form">
                <div class="mb-4">
                    <label for="nik" class="block text-sm font-medium mb-1">NIK (Nomor Induk Kependudukan)</label>
                    <input type="text" id="nik" name="nik" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600" inputmode="numeric" pattern="\d*" required>
                </div>
                <div class="mb-6">
                    <label for="nama" class="block text-sm font-medium mb-1">Nama Lengkap</label>
                    <input type="text" id="nama" name="nama" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-5 rounded-lg transition-all">
                        Batal
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-lg transition-all">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Pengaturan API Key -->
    <div id="apiKey-modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div id="apiKey-modal-content" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm transition-all transform scale-95 opacity-0">
            <h3 class="text-xl font-semibold mb-4">Pengaturan API Key</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Dapatkan API Key Anda dari Google AI Studio. Kunci akan disimpan di browser Anda.
            </p>
            <form id="apiKey-form">
                <div class="mb-6">
                    <label for="apiKey" class="block text-sm font-medium mb-1">Gemini API Key</label>
                    <input type="password" id="apiKey-input" name="apiKey" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="apiKey-cancel-btn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-5 rounded-lg transition-all">
                        Batal
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-lg transition-all">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notifikasi (Sukses/Gagal) -->
    <div id="toast" class="fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white z-[100] transition-all transform translate-x-[200%]">
        <p id="toast-message"></p>
    </div>

    <!-- Hidden Canvas untuk menangkap frame -->
    <canvas id="capture-canvas" class="hidden"></canvas>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Variabel Global ---
            const DB_NAME = 'absensiKTP';
            const API_KEY_NAME = 'geminiApiKey';
            let localStream = null;
            let apiKeyReady = false;
            let cameraReady = false;

            // --- Elemen DOM ---
            const video = document.getElementById('camera-feed');
            const startCameraBtn = document.getElementById('start-camera-btn');
            const scanBtn = document.getElementById('scan-btn');
            const scanOverlay = document.getElementById('scan-overlay');
            const scanStatus = document.getElementById('scan-status');
            const attendanceList = document.getElementById('attendance-list');
            const emptyState = document.getElementById('empty-state');
            const exportBtn = document.getElementById('export-btn');
            
            // --- Elemen Modal Konfirmasi ---
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            const attendanceForm = document.getElementById('attendance-form');
            const nikInput = document.getElementById('nik');
            const namaInput = document.getElementById('nama');
            const cancelBtn = document.getElementById('cancel-btn');

            // --- Elemen Modal API Key ---
            const settingsBtn = document.getElementById('settings-btn');
            const apiKeyModalContainer = document.getElementById('apiKey-modal-container');
            const apiKeyModalContent = document.getElementById('apiKey-modal-content');
            const apiKeyForm = document.getElementById('apiKey-form');
            const apiKeyInput = document.getElementById('apiKey-input');
            const apiKeyCancelBtn = document.getElementById('apiKey-cancel-btn');

            // --- Elemen Toast ---
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            // --- Canvas ---
            const canvas = document.getElementById('capture-canvas');
            const context = canvas.getContext('2d');
            
            // --- Fungsi Inisialisasi ---
            function init() {
                loadAttendanceList();
                checkApiKey();
                
                // Event Listeners
                startCameraBtn.addEventListener('click', startCamera);
                scanBtn.addEventListener('click', triggerScan);
                attendanceForm.addEventListener('submit', handleSubmit);
                cancelBtn.addEventListener('click', () => hideModal(modalContainer, modalContent));
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) hideModal(modalContainer, modalContent);
                });
                exportBtn.addEventListener('click', exportToCSV);
                
                // Event Listeners API Key Modal
                settingsBtn.addEventListener('click', () => showModal(apiKeyModalContainer, apiKeyModalContent));
                apiKeyForm.addEventListener('submit', saveApiKey);
                apiKeyCancelBtn.addEventListener('click', () => hideModal(apiKeyModalContainer, apiKeyModalContent));
                apiKeyModalContainer.addEventListener('click', (e) => {
                    if (e.target === apiKeyModalContainer) hideModal(apiKeyModalContainer, apiKeyModalContent);
                });
            }
            
            // --- Cek API Key ---
            function checkApiKey() {
                const apiKey = localStorage.getItem(API_KEY_NAME);
                if (apiKey) {
                    apiKeyReady = true;
                    apiKeyInput.value = apiKey; // Isi field jika sudah ada
                    console.log('API Key sudah tersimpan.');
                } else {
                    apiKeyReady = false;
                    console.log('API Key belum diatur.');
                    // Tampilkan modal pengaturan jika API key belum ada
                    setTimeout(() => showModal(apiKeyModalContainer, apiKeyModalContent), 500);
                }
                updateScanButtonState();
            }

            // --- Simpan API Key ---
            function saveApiKey(e) {
                e.preventDefault();
                const apiKey = apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem(API_KEY_NAME, apiKey);
                    apiKeyReady = true;
                    hideModal(apiKeyModalContainer, apiKeyModalContent);
                    showToast('API Key berhasil disimpan.', 'success');
                    updateScanButtonState();
                } else {
                    showToast('API Key tidak boleh kosong.', 'error');
                }
            }

            // --- Fungsi Kamera ---
            async function startCamera() {
                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment', // Prioritaskan kamera belakang
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: false
                    };
                    localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = localStream;
                    video.play(); // Pastikan video diputar
                    startCameraBtn.classList.add('hidden');
                    cameraReady = true;
                    updateScanButtonState();
                } catch (err) {
                    console.error("Error mengakses kamera:", err);
                    showToast(`Error kamera: ${err.message}`, 'error');
                    cameraReady = false;
                    // Fallback jika kamera belakang gagal
                    if (err.name === "OverconstrainedError" || err.name === "NotFoundError") {
                         try {
                            const fallbackConstraints = { video: true, audio: false };
                            localStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                            video.srcObject = localStream;
                            video.play();
                            startCameraBtn.classList.add('hidden');
                            cameraReady = true;
                            updateScanButtonState();
                        } catch (fallbackErr) {
                            showToast('Tidak dapat mengakses kamera.', 'error');
                            console.error("Error fallback kamera:", fallbackErr);
                        }
                    }
                }
            }
            
            // --- Cek Status Tombol Scan ---
            function updateScanButtonState() {
                if (cameraReady && apiKeyReady) {
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = `
                        <ion-icon name="scan-outline" class="text-2xl"></ion-icon>
                        Scan KTP Sekarang
                    `;
                } else if (!apiKeyReady) {
                    scanBtn.disabled = true;
                    scanBtn.innerHTML = '<span>Masukkan API Key di Pengaturan</span>';
                } else if (!cameraReady) {
                    scanBtn.disabled = true;
                    scanBtn.innerHTML = '<span>Aktifkan Kamera...</span>';
                }
            }

            // --- Fungsi "Scan" (Menjalankan Gemini AI) ---
            async function triggerScan() {
                if (!localStream || !cameraReady || !apiKeyReady) {
                    showToast('Kamera atau API Key belum siap.', 'error');
                    return;
                }
                
                // 1. Tampilkan overlay "Memproses..."
                scanStatus.textContent = 'Mengambil gambar...';
                scanOverlay.classList.remove('hidden');
                scanOverlay.classList.add('flex');

                // 2. Ambil gambar dari video dan taruh di canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // 3. Konversi ke Base64
                // Gunakan 'image/jpeg' untuk ukuran file yang lebih kecil
                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                // Hapus prefix "data:image/jpeg;base64,"
                const base64ImageData = imageDataUrl.split(',')[1];

                // 4. Jalankan Panggilan API Gemini
                scanStatus.textContent = 'Menghubungi AI Gemini...';
                
                try {
                    const parsedData = await callGeminiAPI(base64ImageData);
                    console.log("Hasil Parsing:", parsedData);

                    // 5. Isi modal dengan hasil parsing
                    nikInput.value = parsedData.nik || '';
                    namaInput.value = parsedData.nama || '';

                    // 6. Sembunyikan overlay dan tampilkan modal
                    scanOverlay.classList.add('hidden');
                    scanOverlay.classList.remove('flex');
                    showModal(modalContainer, modalContent);
                    
                    if (!parsedData.nik && !parsedData.nama) {
                         showToast('AI tidak menemukan data. Coba lagi.', 'error');
                    } else if (!parsedData.nik) {
                        showToast('NIK tidak terbaca. Mohon periksa.', 'error');
                    } else if (!parsedData.nama) {
                        showToast('Nama tidak terbaca. Mohon periksa.', 'error');
                    }

                } catch (err) {
                    console.error("Error saat memanggil API Gemini:", err);
                    showToast(`Gagal: ${err.message}`, 'error');
                    scanOverlay.classList.add('hidden');
                    scanOverlay.classList.remove('flex');
                }
            }

            // --- Fungsi Panggilan API Gemini ---
            async function callGeminiAPI(base64ImageData) {
                const apiKey = localStorage.getItem(API_KEY_NAME);
                if (!apiKey) {
                    throw new Error('API Key tidak ditemukan.');
                }
                
                // Ganti dengan model Gemini yang sesuai (misal: gemini-2.5-flash-preview-09-2025)
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    "contents": [
                        {
                            "parts": [
                                {
                                    "text": "Anda adalah pakar OCR untuk KTP Indonesia. Ekstrak HANYA NIK (16 digit) dan Nama dari gambar KTP ini. Jawab HANYA dengan format JSON: {\"nik\": \"NIK_ANDA\", \"nama\": \"NAMA_LENGKAP_ANDA\"}. Jika salah satu tidak ditemukan, isi dengan null."
                                },
                                {
                                    "inlineData": {
                                        "mimeType": "image/jpeg",
                                        "data": base64ImageData
                                    }
                                }
                            ]
                        }
                    ]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Error API Response:", errorBody);
                    throw new Error(`API Error (${response.status}): ${errorBody.error.message || 'Gagal terhubung'}`);
                }

                const result = await response.json();
                
                // Cek jika response valid
                if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0].text) {
                    console.warn("Struktur respons API tidak terduga:", result);
                    throw new Error('Respons AI tidak valid.');
                }

                const jsonText = result.candidates[0].content.parts[0].text;
                return parseGeminiResult(jsonText);
            }

            // --- Fungsi Parsing Hasil Gemini ---
            function parseGeminiResult(text) {
                try {
                    // Gemini mungkin mengembalikan teks dengan backtick markdown, kita bersihkan dulu
                    const cleanedText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(cleanedText);
                    
                    // Bersihkan data
                    let nik = data.nik ? String(data.nik).replace(/\D/g, '') : null; // Hanya angka
                    let nama = data.nama ? String(data.nama).replace(/\s+/g, ' ').trim().toUpperCase() : null; // Spasi normal, UPPERCASE

                    return { nik, nama };
                } catch (err) {
                    console.error("Gagal parsing JSON dari Gemini:", err, "Teks Asli:", text);
                    showToast('AI mengembalikan format data yang salah.', 'error');
                    return { nik: null, nama: null };
                }
            }

            // --- Fungsi Modal (Generik) ---
            function showModal(container, content) {
                container.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function hideModal(container, content) {
                content.classList.add('scale-95', 'opacity-0');
                content.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 200);
            }

            // --- Fungsi Penyimpanan & Logika Bisnis ---
            // (Fungsi handleSubmit, getAttendanceData, saveAttendanceData tetap sama)
            function handleSubmit(e) {
                e.preventDefault();
                const nik = nikInput.value.trim();
                const nama = namaInput.value.trim().toUpperCase(); // Simpan nama dalam huruf kapital
                const timestamp = new Date().toISOString();

                if (!nik || !nama) {
                    showToast('NIK dan Nama tidak boleh kosong.', 'error');
                    return;
                }

                if (!/^\d{16}$/.test(nik)) {
                    showToast('Format NIK salah. Harus 16 digit angka.', 'error');
                    return;
                }

                const attendanceData = getAttendanceData();
                const isDuplicate = attendanceData.some(item => item.nik === nik);
                if (isDuplicate) {
                    showToast(`Gagal: ${nama} (NIK: ${nik}) sudah terdaftar hadir.`, 'error');
                    hideModal(modalContainer, modalContent);
                    return;
                }

                const newEntry = { nik, nama, waktu: timestamp };
                attendanceData.push(newEntry);
                saveAttendanceData(attendanceData);

                showToast(`Sukses: ${nama} berhasil diabsen.`, 'success');
                loadAttendanceList();
                hideModal(modalContainer, modalContent);
            }

            function getAttendanceData() {
                return JSON.parse(localStorage.getItem(DB_NAME) || '[]');
            }

            function saveAttendanceData(data) {
                localStorage.setItem(DB_NAME, JSON.stringify(data));
                checkExportButtonState(data);
            }

            // --- Fungsi Tampilan (Rendering) ---
            // (Fungsi loadAttendanceList dan checkExportButtonState tetap sama)
            function loadAttendanceList() {
                const data = getAttendanceData();
                checkExportButtonState(data);

                if (data.length === 0) {
                    emptyState.classList.remove('hidden');
                    attendanceList.innerHTML = ''; // Hapus list lama
                    attendanceList.appendChild(emptyState);
                    return;
                }

                emptyState.classList.add('hidden');
                attendanceList.innerHTML = '';

                data.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

                data.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0';
                    const time = new Date(item.waktu);
                    const formattedTime = time.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    
                    listItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-gray-100">${item.nama}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">NIK: ...${item.nik.slice(-4)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-medium text-gray-700 dark:text-gray-300">${formattedTime}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${time.toLocaleDateString('id-ID')}</p>
                        </div>
                    `;
                    attendanceList.appendChild(listItem);
                });
            }

            function checkExportButtonState(data) {
                exportBtn.disabled = data.length === 0;
            }

            // --- Fungsi Ekspor CSV ---
            // (Fungsi exportToCSV tetap sama)
             function exportToCSV() {
                const data = getAttendanceData();
                if (data.length === 0) {
                    showToast('Tidak ada data untuk diekspor.', 'error');
                    return;
                }
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "NIK,Nama,Waktu Kehadiran\n"; // Header
                data.forEach(item => {
                    const time = new Date(item.waktu).toLocaleString('id-ID');
                    const row = `"${item.nik}","${item.nama}","${time}"`;
                    csvContent += row + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `absensi_ktp_gemini_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('Data berhasil diekspor.', 'success');
            }

            // --- Fungsi Notifikasi (Toast) ---
            // (Fungsi showToast tetap sama)
            let toastTimer;
            function showToast(message, type = 'success') {
                clearTimeout(toastTimer); 
                toastMessage.textContent = message;
                toast.classList.remove('bg-green-500', 'bg-red-500', 'translate-x-[200%]', 'translate-x-0');
                toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
                toast.classList.add('translate-x-0');
                toastTimer = setTimeout(() => {
                    toast.classList.add('translate-x-[200%]');
                    toast.classList.remove('translate-x-0');
                }, 3000);
            }

            // --- Jalankan Aplikasi ---
            init();
        });
    </script>
</body>
</html>

